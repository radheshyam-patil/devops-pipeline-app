pipeline {
   agent any

   environment {
       DOCKERHUB_CREDENTIALS = credentials('dockerhub-creds')
       DOCKER_USER = 'radheshyampatil'   // your DockerHub username
       IMAGE_NAME = 'devops-pipeline-app'
   }

   stages {
       stage('Checkout') {
           steps {
               git branch: 'main', url: 'https://github.com/radheshyam-patil/devops-project.git'
           }
       }

       stage('Build Docker Image') {
           steps {
               script {
                   sh "docker build -t ${DOCKER_USER}/${IMAGE_NAME}:latest ."
               }
           }
       }

       stage('Push to DockerHub') {
           steps {
               script {
                   sh "echo ${DOCKERHUB_CREDENTIALS_PSW} | docker login -u ${DOCKERHUB_CREDENTIALS_USR} --password-stdin"
                   sh "docker push ${DOCKER_USER}/${IMAGE_NAME}:latest"
               }
           }
       }

       stage('Deploy Container') {
           steps {
               script {
                   // Stop old container if exists
                   sh "docker stop ${IMAGE_NAME} || true && docker rm ${IMAGE_NAME} || true"

                   // Run new container
                   sh "docker run -d --name ${IMAGE_NAME} -p 3000:3000 ${DOCKER_USER}/${IMAGE_NAME}:latest"
               }
           }
       }
   }
}
